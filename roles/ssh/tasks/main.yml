---
- name: Set authorized keys
  ansible.posix.authorized_key:
    user: "{{ user }}"
    state: present
    key: "{{ lookup('ansible.builtin.file', item) }}"
  loop:
    - adrianzech.pub
  register: ssh_add_identity_key

- name: Disable root login over ssh
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PermitRootLogin"
    line: "PermitRootLogin {{ ssh_permit_root_login }}"
    state: present
  notify:
    - Restart sshd

- name: Disable password login over ssh
  ansible.builtin.lineinfile:
    path: /etc/ssh/sshd_config
    regexp: "^#?PasswordAuthentication"
    line: "PasswordAuthentication {{ ssh_password_authentication }}"
    state: present
  when:
    - ssh_add_identity_key is succeeded
  notify:
    - Restart sshd
